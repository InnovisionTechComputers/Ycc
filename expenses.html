<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® - ‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏</title>
    <style>
        body { display: flex; font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        .sidebar { width: 250px; background: #2c3e50; color: white; height: 100vh; padding: 20px; position: fixed; }
        .sidebar h2 { color: #3498db; text-align: center; }
        .sidebar a { display: block; color: white; padding: 15px; text-decoration: none; border-bottom: 1px solid #3e4f5f; }
        
        .main { margin-left: 280px; padding: 30px; width: calc(100% - 310px); }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        .lang-container { position: absolute; top: 20px; right: 25px; }
        .lang-btn { background: #3498db; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }

        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .box { background: white; padding: 20px; border-radius: 8px; flex: 1; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .entry-section { background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 25px; border: 1px solid #ddd; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: flex-end; }
        
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        
        .add-btn { background: #e74c3c; color: white; border: none; padding: 11px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .add-btn:hover { background: #c0392b; }

        table { width: 100%; background: white; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #2c3e50; color: white; }
        .loader { font-weight: bold; color: #e67e22; display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 id="sideTitle">‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏</h2>
        <a href="dashboard.html" id="navNewAdm">üìù ‡§®‡§µ‡•Ä‡§® ‡§ç‡§°‡§Æ‡§ø‡§∂‡§®</a>
        <a href="view-students.html" id="navStudentList">üìã ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§Ø‡§æ‡§¶‡•Ä</a>
        <a href="attendance.html" id="navAttendance">üìÖ ‡§π‡§ú‡•á‡§∞‡•Ä</a>
        <a href="results.html" id="navResults">üìä ‡§®‡§ø‡§ï‡§æ‡§≤/‡§Æ‡§æ‡§∞‡•ç‡§ï</a>
        <a href="fees.html" id="navFees">üí∞ ‡§´‡•Ä ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°</a>
        <a href="expenses.html" style="background:#3498db" id="navExpenses">üí∏ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</a>
        <a href="#" onclick="logout()" id="navLogout">üö™ Log Out</a>
    </div>

    <div class="main">
        <div class="lang-container">
            <button class="lang-btn" id="langBtn" onclick="toggleLang()">English</button>
        </div>
        
        <h2 id="pageTitle" style="color: #2c3e50;">üí∏ ‡§¶‡•à‡§®‡§Ç‡§¶‡§ø‡§® ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§£‡§ø ‡§π‡§ø‡§∂‡•ã‡§¨</h2>

        <div class="stats">
            <div class="box"><h3 style="color: #27ae60;"><span id="lblInc">‡§è‡§ï‡•Ç‡§£ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§®</span>: <span id="totalIncome">‚Çπ ‡•¶</span></h3></div>
            <div class="box"><h3 style="color: #e74c3c;"><span id="lblExp">‡§è‡§ï‡•Ç‡§£ ‡§ñ‡§∞‡•ç‡§ö</span>: <span id="totalExpense">‚Çπ ‡•¶</span></h3></div>
            <div class="box"><h3 style="color: #3498db;"><span id="lblProfit">‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ ‡§®‡§´‡§æ</span>: <span id="netProfit">‚Çπ ‡•¶</span></h3></div>
        </div>

        <div class="entry-section">
            <h3 id="formTitle">‡§®‡§µ‡•Ä‡§® ‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§ï‡§∞‡§æ <span id="saveLoader" class="loader">...</span></h3>
            <div class="form-grid">
                <div>
                    <label id="lblDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                    <input type="date" id="expDate">
                </div>
                <div>
                    <label id="lblCat">‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:</label>
                    <select id="expCategory"></select>
                </div>
                <div>
                    <label id="lblAmt">‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):</label>
                    <input type="number" id="expAmount" placeholder="0.00">
                </div>
                <button class="add-btn" id="addBtn" onclick="addExpense()">‚úÖ ‡§ñ‡§∞‡•ç‡§ö ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</button>
            </div>
            <div style="margin-top: 10px;">
                <label id="lblNote">‡§§‡§™‡§∂‡•Ä‡§≤ (‡§ü‡•Ä‡§™):</label>
                <input type="text" id="expNote" placeholder="...">
            </div>
        </div>

        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="tableTitle">‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä <span id="tableLoader" class="loader">(...)</span></h3>
                <input type="month" id="filterMonth" style="width: 200px;" onchange="loadExpenses()">
            </div>
            <table>
                <thead>
                    <tr>
                        <th id="thDate">‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
                        <th id="thCat">‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
                        <th id="thNote">‡§§‡§™‡§∂‡•Ä‡§≤</th>
                        <th id="thAmt">‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th>
                    </tr>
                </thead>
                <tbody id="expenseTableBody">
                    <tr><td colspan="4" id="initialMsg">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentLang = sessionStorage.getItem("lang") || 'mr';

        // ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§®‡§µ‡•Ä‡§® Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6jsJF54vLAvcOr5Bq0nPv9aKvDfpmkNmll_4FpztwE5SMneaCQhSilDkkSq6wJOvFtw/exec";

        const langData = {
            mr: {
                sideTitle: "‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏", navNewAdm: "üìù ‡§®‡§µ‡•Ä‡§® ‡§ç‡§°‡§Æ‡§ø‡§∂‡§®", navStudentList: "üìã ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§Ø‡§æ‡§¶‡•Ä", navAttendance: "üìÖ ‡§π‡§ú‡•á‡§∞‡•Ä", navResults: "üìä ‡§®‡§ø‡§ï‡§æ‡§≤/‡§Æ‡§æ‡§∞‡•ç‡§ï", navFees: "üí∞ ‡§´‡•Ä ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°", navExpenses: "üí∏ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®", navLogout: "üö™ Log Out",
                pageTitle: "üí∏ ‡§¶‡•à‡§®‡§Ç‡§¶‡§ø‡§® ‡§ñ‡§∞‡•ç‡§ö ‡§Ü‡§£‡§ø ‡§π‡§ø‡§∂‡•ã‡§¨", lblInc: "‡§è‡§ï‡•Ç‡§£ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§®", lblExp: "‡§è‡§ï‡•Ç‡§£ ‡§ñ‡§∞‡•ç‡§ö", lblProfit: "‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ ‡§®‡§´‡§æ",
                formTitle: "‡§®‡§µ‡•Ä‡§® ‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§ï‡§∞‡§æ", lblDate: "‡§§‡§æ‡§∞‡•Ä‡§ñ:", lblCat: "‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:", lblAmt: "‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ):", lblNote: "‡§§‡§™‡§∂‡•Ä‡§≤ (‡§ü‡•Ä‡§™):", addBtn: "‚úÖ ‡§ñ‡§∞‡•ç‡§ö ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ",
                tableTitle: "‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä", thDate: "‡§§‡§æ‡§∞‡•Ä‡§ñ", thCat: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∞", thNote: "‡§§‡§™‡§∂‡•Ä‡§≤", thAmt: "‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)",
                initialMsg: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã‡§à‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§ ‡§•‡§æ‡§Ç‡§¨‡§æ...", loaderSave: "...‡§∏‡•á‡§µ‡•ç‡§π ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á", loaderTable: "(‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∂‡•ã‡§ß‡§§ ‡§Ü‡§π‡•á...)",
                alertFill: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§Ü‡§£‡§ø ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§≠‡§∞‡§æ!", alertSuccess: "‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡•Ä ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§ù‡§æ‡§≤‡•Ä!", langBtn: "English",
                categories: ["‡§≤‡§æ‡§à‡§ü ‡§¨‡§ø‡§≤", "‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§≠‡§æ‡§°‡•á", "‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï‡§æ‡§Ç‡§ö‡§æ ‡§™‡§ó‡§æ‡§∞", "‡§∏‡•ç‡§ü‡•á‡§∂‡§®‡§∞‡•Ä/‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü‡§ø‡§Ç‡§ó", "‡§ú‡§æ‡§π‡§ø‡§∞‡§æ‡§§", "‡§á‡§§‡§∞ ‡§ñ‡§∞‡•ç‡§ö"]
            },
            en: {
                sideTitle: "Yashodeep Classes", navNewAdm: "üìù New Admission", navStudentList: "üìã Student List", navAttendance: "üìÖ Attendance", navResults: "üìä Marks/Results", navFees: "üí∞ Fee Records", navExpenses: "üí∏ Expenses", navLogout: "üö™ Log Out",
                pageTitle: "üí∏ Daily Expenses & Accounts", lblInc: "Total Income", lblExp: "Total Expense", lblProfit: "Net Profit",
                formTitle: "Record New Expense", lblDate: "Date:", lblCat: "Category:", lblAmt: "Amount (‚Çπ):", lblNote: "Details (Note):", addBtn: "‚úÖ Add Expense",
                tableTitle: "Expense List", thDate: "Date", thCat: "Type", thNote: "Details", thAmt: "Amount (‚Çπ)",
                initialMsg: "Please wait while loading...", loaderSave: "...Saving", loaderTable: "(Searching...)",
                alertFill: "Please fill date and amount!", alertSuccess: "Expense recorded successfully!", langBtn: "‡§Æ‡§∞‡§æ‡§†‡•Ä",
                categories: ["Electricity Bill", "Class Rent", "Teacher Salary", "Stationery/Printing", "Marketing", "Other"]
            }
        };

        document.addEventListener("DOMContentLoaded", function() {
            if (sessionStorage.getItem("isLoggedIn") !== "true") { window.location.href = "index.html"; return; }
            document.getElementById('expDate').valueAsDate = new Date();
            document.getElementById('filterMonth').value = new Date().toISOString().substring(0, 7);
            updateLanguageUI();
            loadExpenses();
        });

        function toggleLang() {
            currentLang = (currentLang === 'mr') ? 'en' : 'mr';
            sessionStorage.setItem("lang", currentLang);
            updateLanguageUI();
        }

        function updateLanguageUI() {
            const t = langData[currentLang];
            for (let id in t) {
                const el = document.getElementById(id);
                if (el && typeof t[id] === 'string') el.innerText = t[id];
            }
            const catSelect = document.getElementById('expCategory');
            catSelect.innerHTML = "";
            t.categories.forEach(cat => {
                let opt = document.createElement("option");
                opt.value = cat; opt.innerText = cat; catSelect.appendChild(opt);
            });
            document.getElementById('langBtn').innerText = t.langBtn;
        }

        async function addExpense() {
            const t = langData[currentLang];
            const btn = document.getElementById('addBtn');
            const loader = document.getElementById('saveLoader');
            const date = document.getElementById('expDate').value;
            const category = document.getElementById('expCategory').value;
            const amount = document.getElementById('expAmount').value;
            const note = document.getElementById('expNote').value;

            if(!amount || !date) { alert(t.alertFill); return; }

            btn.disabled = true;
            if(loader) loader.style.display = "inline";

            try {
                // ‡§°‡•á‡§ü‡§æ ‡§™‡§æ‡§†‡§µ‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§ñ‡§æ‡§§‡•ç‡§∞‡•Ä‡§∂‡•Ä‡§∞ ‡§™‡§¶‡•ç‡§ß‡§§
                const response = await fetch(SCRIPT_URL, { 
                    method: 'POST',
                    body: JSON.stringify({ 
                        type: "AddExpense", 
                        date: date, 
                        category: category, 
                        amount: amount, 
                        note: note 
                    })
                });

                alert(t.alertSuccess);
                document.getElementById('expAmount').value = "";
                document.getElementById('expNote').value = "";
                loadExpenses(); // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ

            } catch (e) { 
                console.error("Save Error:", e);
                alert("‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á ‡§®‡§æ‡§π‡•Ä! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§µ‡•Ä‡§® Deployment URL ‡§µ‡§æ‡§™‡§∞‡§æ."); 
            } 
            finally { 
                btn.disabled = false; 
                if(loader) loader.style.display = "none"; 
            }
        }

        async function loadExpenses() {
            const t = langData[currentLang];
            const month = document.getElementById('filterMonth').value;
            const tbody = document.getElementById('expenseTableBody');
            
            const loader = document.getElementById('tableLoader') || document.getElementById('initialMsg');
            
            if (loader) {
                loader.style.display = "inline";
                loader.innerText = t.loaderTable;
            }
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getExpenses&month=${month}`);
                let data = await response.json();

                if (typeof data === "string") { data = JSON.parse(data); }

                tbody.innerHTML = "";
                let totalExp = 0;

                if (!data.expenses || data.expenses.length === 0) {
                    tbody.innerHTML = `<tr><td colspan='4'>${currentLang === 'mr' ? '‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.' : 'No data available.'}</td></tr>`;
                } else {
                    data.expenses.forEach(exp => {
                        totalExp += Number(exp.amount || 0);
                        tbody.innerHTML += `
                            <tr>
                                <td>${exp.date || '-'}</td>
                                <td>${exp.category || '-'}</td>
                                <td>${exp.note || '-'}</td>
                                <td style="color: red; font-weight: bold;">‚Çπ ${exp.amount || 0}</td>
                            </tr>
                        `;
                    });
                }
                if(document.getElementById('totalExpense')) document.getElementById('totalExpense').innerText = "‚Çπ " + totalExp;
                if(document.getElementById('netProfit')) document.getElementById('netProfit').innerText = "‚Çπ " + (0 - totalExp); 
            } catch (e) { 
                console.error("Fetch Error:", e);
                tbody.innerHTML = "<tr><td colspan='4'>‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä.</td></tr>"; 
            } 
            finally { if(loader) loader.style.display = "none"; }
        }

        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>
