<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>рдлреА рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди - рдпрд╢реЛрджреАрдк рдХреНрд▓рд╛рд╕реЗрд╕</title>
    <style>
        body { display: flex; font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        .sidebar { width: 250px; background: #2c3e50; color: white; height: 100vh; padding: 20px; position: fixed; }
        .sidebar h2 { color: #3498db; text-align: center; }
        .sidebar a { display: block; color: white; padding: 15px; text-decoration: none; border-bottom: 1px solid #3e4f5f; }
        
        .main { margin-left: 280px; padding: 30px; width: calc(100% - 310px); }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        /* Language Switcher */
        .lang-container { position: absolute; top: 20px; right: 25px; }
        .lang-btn { background: #3498db; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }

        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .box { background: white; padding: 20px; border-radius: 8px; flex: 1; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .filter-section { background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #3498db; }

        table { width: 100%; background: white; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        .loader { font-weight: bold; color: #e67e22; display: none; }
        
        .pay-btn { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .edit-btn { background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .wa-btn { background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 id="sideTitle">рдпрд╢реЛрджреАрдк рдХреНрд▓рд╛рд╕реЗрд╕</h2>
        <a href="dashboard.html"  id="navNewAdm">ЁЯУЭ рдирд╡реАрди рдНрдбрдорд┐рд╢рди</a>
        <a href="view-students.html" id="navStudentList">ЁЯУЛ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдпрд╛рджреА</a>
        <a href="attendance.html" id="navAttendance">ЁЯУЕ рд╣рдЬреЗрд░реА</a>
        <a href="results.html" id="navResults">ЁЯУК рдорд╛рд░реНрдХ рдЕрдкрдбреЗрдЯ</a>
        <a href="fees.html" style="background:#3498db" id="navFees">ЁЯТ░ рдлреА рд░реЗрдХреЙрд░реНрдб</a>
        <a href="expenses.html" id="navExpenses">ЁЯТ╕ рдЦрд░реНрдЪ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</a>
        <a href="#" onclick="logout()" id="navLogout">ЁЯЪк Log Out</a>
    </div>

    <div class="main">
        <div class="card">
            <div class="lang-container">
                <button class="lang-btn" id="langBtn" onclick="toggleLang()">English</button>
            </div>

            <div class="stats">
                <div class="box"><h3 id="txtTotalColl">рдПрдХреВрдг рдЬрдорд╛: <span id="totalCollectedDisplay">тВ╣реж</span></h3></div>
                <div class="box" style="color: red;"><h3 id="txtTotalPend">рдмрд╛рдХреА рдлреА: <span id="totalPendingDisplay">тВ╣реж</span></h3></div>
            </div>

            <div class="filter-section">
                <label><strong id="lblSelectClass">рд╡рд░реНрдЧ рдирд┐рд╡рдбрд╛:</strong></label>
                <select id="feeClassFilter" onchange="loadFeeData()">
                    <option value="" id="optSelect">-- рдирд┐рд╡рдбрд╛ --</option>
                    <option value="5">рел рд╡реА</option><option value="6">рем рд╡реА</option>
                    <option value="7">рен рд╡реА</option><option value="8">рео рд╡реА</option>
                    <option value="9">реп рд╡реА</option><option value="10">резреж рд╡реА</option>
                    <option value="11">резрез рд╡реА</option><option value="12">резреи рд╡реА</option>
                </select>
                <span id="loader" class="loader">рдорд╛рд╣рд┐рддреА рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗ...</span>
            </div>

            <h2 id="tableTitle">рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдлреА рддрдкрд╢реАрд▓</h2>
            <table>
                <thead>
                    <tr>
                        <th>PRN</th>
                        <th id="thName">рдирд╛рд╡</th>
                        <th id="thTotal">рдПрдХреВрдг рдлреА (Total)</th>
                        <th id="thPaid">рднрд░рд▓реЗрд▓реА рдлреА (Paid)</th>
                        <th id="thPend">рдмрд╛рдХреА рдлреА (Pending)</th>
                        <th id="thAction">рдХреГрддреА (Action)</th>
                    </tr>
                </thead>
                <tbody id="feeTableBody">
                    <tr><td colspan="6" id="initialMsg">рдХреГрдкрдпрд╛ рд╡рд░реАрд▓ рд╡рд░реНрдЧ рдирд┐рд╡рдбрд╛...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentLang = sessionStorage.getItem("lang") || 'mr';

        const langData = {
            mr: {
                sideTitle: "рдпрд╢реЛрджреАрдк рдХреНрд▓рд╛рд╕реЗрд╕", navNewAdm: "ЁЯУЭ рдирд╡реАрди рдНрдбрдорд┐рд╢рди", navStudentList: "ЁЯУЛ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдпрд╛рджреА", navAttendance: "ЁЯУЕ рд╣рдЬреЗрд░реА", navFees: "ЁЯТ░ рдлреА рд░реЗрдХреЙрд░реНрдб", navResults: "ЁЯУК рдирд┐рдХрд╛рд▓/рдорд╛рд░реНрдХ", navExpenses: "ЁЯТ╕ рдЦрд░реНрдЪ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди", navLogout: "ЁЯЪк Log Out",
                txtTotalColl: "рдПрдХреВрдг рдЬрдорд╛: ", txtTotalPend: "рдмрд╛рдХреА рдлреА: ", lblSelectClass: "рд╡рд░реНрдЧ рдирд┐рд╡рдбрд╛:", optSelect: "-- рдирд┐рд╡рдбрд╛ --", tableTitle: "рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдлреА рддрдкрд╢реАрд▓",
                thName: "рдирд╛рд╡", thTotal: "рдПрдХреВрдг рдлреА (Total)", thPaid: "рднрд░рд▓реЗрд▓реА рдлреА (Paid)", thPend: "рдмрд╛рдХреА рдлреА (Pending)", thAction: "рдХреГрддреА (Action)",
                initialMsg: "рдХреГрдкрдпрд╛ рд╡рд░реАрд▓ рд╡рд░реНрдЧ рдирд┐рд╡рдбрд╛...", loader: "рдорд╛рд╣рд┐рддреА рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗ...", btnEdit: "тЬПя╕П рдлреА рд╕реЗрдЯ рдХрд░рд╛", btnPay: "ЁЯТ░ рдЬрдорд╛",
                promptTotal: "{name} рд╕рд╛рдареА рдирд╡реАрди 'рдПрдХреВрдг рдлреА' рдЯрд╛рдХрд╛:", promptCollect: "{name} рдХрдбреВрди рдЬрдорд╛ рдЭрд╛рд▓реЗрд▓реА рд░рдХреНрдХрдо рдЯрд╛рдХрд╛:",
                alertSuccess: "рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рдЕрдкрдбреЗрдЯ рдЭрд╛рд▓реЗ!", alertError: "рддреНрд░реБрдЯреА рдЖрд▓реА!", waMsg: "*рдпрд╢реЛрджреАрдк рдХреНрд▓рд╛рд╕реЗрд╕ - рдлреА рд░рд┐рдорд╛рдЗрдиреНрдбрд░*%0A%0Aрдирдорд╕реНрдХрд╛рд░, рдХрд│рд╡рдгреНрдпрд╛рдд рдпреЗрддреЗ рдХреА рдЖрдкрд▓рд╛ рдореБрд▓рдЧрд╛/рдореБрд▓рдЧреА *{name}* рдпрд╛рдЪреА рдХреНрд▓рд╛рд╕рдЪреА *тВ╣{amount}* рдлреА рднрд░рд╛рдпрдЪреА рдмрд╛рдХреА рдЖрд╣реЗ. рддрд░реА рдХреГрдкрдпрд╛ рддреА рд▓рд╡рдХрд░рд╛рдд рд▓рд╡рдХрд░ рдЬрдорд╛ рдХрд░рд╛рд╡реА рд╣реА рд╡рд┐рдирдВрддреА.", langBtn: "English"
            },
            en: {
                sideTitle: "Yashodeep Classes", navNewAdm: "ЁЯУЭ New Admission", navStudentList: "ЁЯУЛ Student List", navAttendance: "ЁЯУЕ Attendance", navFees: "ЁЯТ░ Fee Records", navResults: "ЁЯУК Marks/Results", navExpenses: "ЁЯТ╕ Expenses", navLogout: "ЁЯЪк Log Out",
                txtTotalColl: "Total Collected: ", txtTotalPend: "Total Pending: ", lblSelectClass: "Select Class:", optSelect: "-- Select --", tableTitle: "Student Fee Details",
                thName: "Name", thTotal: "Total Fee", thPaid: "Paid Fee", thPend: "Pending Fee", thAction: "Action",
                initialMsg: "Please select a class...", loader: "Loading data...", btnEdit: "тЬПя╕П Set Fee", btnPay: "ЁЯТ░ Collect",
                promptTotal: "Enter new 'Total Fee' for {name}:", promptCollect: "Enter amount collected from {name}:",
                alertSuccess: "Updated successfully!", alertError: "An error occurred!", waMsg: "*Yashodeep Classes - Fee Reminder*%0A%0AHello, this is to inform you that child *{name}* has a pending fee of *тВ╣{amount}*. Kindly deposit it at the earliest.", langBtn: "рдорд░рд╛рдареА"
            }
        };

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDWoZGknNyFlYt0G9TBsDKE4RtRkxw_PsCQSVHHfwDajR7hqGzNWAmr97hUmIqvgCjgw/exec";

        document.addEventListener("DOMContentLoaded", function() {
            const role = sessionStorage.getItem("userRole");
            if (sessionStorage.getItem("isLoggedIn") !== "true") { window.location.href = "index.html"; return; }
            if (role === "md") { window.location.href = "dashboard.html"; return; } // MD рд▓рд╛ рдкреВрд░реНрдгрдкрдгреЗ рдмреНрд▓реЙрдХ рдХрд░рд╛
            updateLanguageUI();
        });

        function toggleLang() {
            currentLang = (currentLang === 'mr') ? 'en' : 'mr';
            sessionStorage.setItem("lang", currentLang);
            updateLanguageUI();
            loadFeeData();
        }

        function updateLanguageUI() {
            const t = langData[currentLang];
            for (let id in t) {
                const el = document.getElementById(id);
                if (el) el.innerText = t[id];
            }
            // Stats рдЪреНрдпрд╛ рд╕реНрдкреЕрди рд╡реНрд╣реЕрд▓реНрдпреВ рдЯрд┐рдХрд╡реВрди рдареЗрд╡рдгреНрдпрд╛рд╕рд╛рдареА
            document.getElementById('txtTotalColl').innerHTML = t.txtTotalColl + `<span id="totalCollectedDisplay">тВ╣реж</span>`;
            document.getElementById('txtTotalPend').innerHTML = t.txtTotalPend + `<span id="totalPendingDisplay">тВ╣реж</span>`;
        }

        async function loadFeeData() {
            const selectedClass = document.getElementById('feeClassFilter').value;
            const tableBody = document.getElementById('feeTableBody');
            const loader = document.getElementById('loader');
            const t = langData[currentLang];

            if (!selectedClass) { tableBody.innerHTML = `<tr><td colspan="6">${t.initialMsg}</td></tr>`; return; }
            loader.style.display = "inline";
            tableBody.innerHTML = "";

            try {
                const response = await fetch(`${SCRIPT_URL}?action=read&className=Class ${selectedClass}`);
                const data = await response.json();
                let totalColl = 0, totalPend = 0;

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">No students found.</td></tr>';
                } else {
                    data.forEach(student => {
                        let totalFee = Number(student.totalFee) || 0; 
                        let paidFee = Number(student.paid) || 0; 
                        let pendingFee = totalFee - paidFee;
                        totalColl += paidFee; totalPend += pendingFee;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${student.prn}</td>
                            <td>${student.name}</td>
                            <td>тВ╣ ${totalFee}</td>
                            <td>тВ╣ ${paidFee}</td>
                            <td style="color:${pendingFee > 0 ? 'red' : 'green'}; font-weight:bold;">тВ╣ ${pendingFee}</td>
                            <td>
                                <button class="edit-btn" onclick="updateTotalFee('${student.prn}', '${student.name}', ${totalFee})">${t.btnEdit}</button>
                                <button class="pay-btn" onclick="collectFee('${student.prn}', '${student.name}')">${t.btnPay}</button>
                                ${pendingFee > 0 ? `<button class="wa-btn" onclick="sendFeeReminder('${student.name}', '${student.parentPhone}', '${pendingFee}')">ЁЯУ▓</button>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    document.getElementById('totalCollectedDisplay').innerText = "тВ╣" + totalColl;
                    document.getElementById('totalPendingDisplay').innerText = "тВ╣" + totalPend;
                }
            } catch (error) { alert(t.alertError); } 
            finally { loader.style.display = "none"; }
        }

        async function updateTotalFee(prn, name, currentFee) {
            const t = langData[currentLang];
            let newTotal = prompt(t.promptTotal.replace("{name}", name), currentFee);
            if (newTotal) {
                await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ type: "UpdateTotalFee", prn: prn, className: "Class " + document.getElementById('feeClassFilter').value, newTotal: newTotal })
                });
                alert(t.alertSuccess); loadFeeData();
            }
        }

        async function collectFee(prn, name) {
            const t = langData[currentLang];
            let amount = prompt(t.promptCollect.replace("{name}", name));
            if (amount) {
                await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ type: "CollectFee", prn: prn, className: "Class " + document.getElementById('feeClassFilter').value, amount: amount })
                });
                alert("тВ╣" + amount + " " + t.alertSuccess); loadFeeData();
            }
        }

        function sendFeeReminder(name, phone, amount) {
            const t = langData[currentLang];
            let message = t.waMsg.replace("{name}", name).replace("{amount}", amount);
            let cleanPhone = phone ? phone.toString().replace(/\D/g, '') : "";
            if (cleanPhone.length === 10) cleanPhone = "91" + cleanPhone;
            window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
        }

        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>